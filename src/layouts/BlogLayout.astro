---
import type { CollectionEntry } from 'astro:content';
import PageLayout from '@/components/layout/PageLayout.astro';
import Container from '@/components/layout/Container.astro';
import ShareButtons from '@/components/blog/ShareButtons';
import TableOfContents from '@/components/blog/TableOfContents';
import RelatedArticles from '@/components/blog/RelatedArticles';
import BlogCTA from '@/components/blog/BlogCTA';
import { formatDate, formatDateShort } from '@/lib/utils';
import { ArticleBookingWidget } from '@/components/blog/ArticleBookingWidget';
import { HotelShowcase } from '@/components/blog/HotelShowcase';
import { HotelGrid } from '@/components/blog/HotelGrid';
import { ActivityShowcase } from '@/components/blog/ActivityShowcase';
import { TripCalculator } from '@/components/planning/TripCalculator';
import { HotelComparison } from '@/components/planning/HotelComparison';
import { SeasonComparison } from '@/components/planning/SeasonComparison';
import { GroupTypeRecommender } from '@/components/planning/GroupTypeRecommender';
import { EventPlanningTimeline } from '@/components/planning/EventPlanningTimeline';
import { GroupCostCalculator } from '@/components/planning/GroupCostCalculator';
import { HotelSplitCalculator } from '@/components/planning/HotelSplitCalculator';
import { CostPerPersonRanking } from '@/components/planning/CostPerPersonRanking';
import { BudgetToItineraryPlanner } from '@/components/planning/BudgetToItineraryPlanner';

interface Props {
  article: CollectionEntry<'blog'>;
  relatedArticles?: CollectionEntry<'blog'>[];
  headings?: Array<{ id: string; text: string; level: number }>;
}

const { article, relatedArticles = [], headings = [] } = Astro.props;
const { data, render } = article;
const { Content } = await render();

const fullUrl = `${Astro.site}blog/${data.category}/${article.slug}`;
const categoryName = data.category.replace(/-/g, ' ');
---

<PageLayout
  title={data.seo.metaTitle}
  description={data.seo.metaDescription}
  image={data.featuredImage}
>
  <article>
    <!-- Breadcrumbs -->
    <Container>
      <nav class="pt-6 pb-4 text-sm text-[#999]" aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 max-w-[1200px] mx-auto">
          <li><a href="/" class="hover:text-[#2D5F4F] transition-colors">Home</a></li>
          <li class="text-[#999]">/</li>
          <li><a href="/blog" class="hover:text-[#2D5F4F] transition-colors">Blog</a></li>
          <li class="text-[#999]">/</li>
          <li><a href={`/blog/${data.category}`} class="hover:text-[#2D5F4F] transition-colors capitalize">{categoryName}</a></li>
          <li class="text-[#999]">/</li>
          <li class="text-[#2C2C2C] truncate max-w-[200px]">{data.title}</li>
        </ol>
      </nav>
    </Container>

    <!-- Hero Section with Overlay -->
    <div class="relative h-[350px] md:h-[500px] overflow-hidden">
      <img
        src={data.featuredImage}
        alt={data.featuredImageAlt}
        class="absolute inset-0 w-full h-full object-cover"
        loading="eager"
      />
      <!-- Gradient Overlay -->
      <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent"></div>
      
      <!-- Content Overlay -->
      <Container>
        <div class="relative h-full flex flex-col justify-end pb-12 md:pb-16">
          <div class="max-w-[800px]">
            <!-- Category Badge -->
            <span class="inline-block mb-4 px-3 py-1.5 bg-[#2D5F4F] text-white text-[11px] uppercase tracking-wider rounded font-medium">
              {categoryName}
            </span>
            
            <!-- Title -->
            <h1 
              class="text-3xl md:text-4xl lg:text-5xl font-bold text-white mb-4 leading-tight"
              style="font-family: 'Playfair Display', serif; text-shadow: 0 2px 8px rgba(0,0,0,0.3);"
            >
              {data.title}
            </h1>
            
            <!-- Metadata -->
            <div class="flex flex-wrap items-center gap-3 text-sm text-white/90">
              <span>By {data.author}</span>
              <span>•</span>
              <time datetime={data.publishDate.toISOString()}>
                {formatDateShort(data.publishDate)}
              </time>
              <span>•</span>
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {data.readingTime} min read
              </span>
            </div>
          </div>
        </div>
      </Container>
    </div>

    <!-- Gradient Transition -->
    <div class="h-10 bg-gradient-to-b from-transparent to-white"></div>

    <Container>

      <div class="grid gap-8 lg:grid-cols-[1fr_280px] py-12">
        <!-- Main Content -->
        <div class="max-w-[720px] mx-auto lg:mx-0 relative">
          <!-- Social Share - Sticky in Column (Desktop) -->
          <div class="hidden lg:block absolute -left-24 top-0 h-full">
            <div class="sticky top-24">
            <ShareButtons client:load url={fullUrl} title={data.title} />
            </div>
          </div>

          <!-- Social Share - Above Content (Mobile/Tablet) -->
          <div class="lg:hidden mb-8">
            <ShareButtons client:load url={fullUrl} title={data.title} />
          </div>

          <!-- Article Content -->
          <div class="prose prose-lg max-w-3xl 
            prose-headings:font-semibold 
            prose-headings:text-[#2C2C2C]
            prose-h2:mt-12 prose-h2:mb-4 prose-h2:text-[32px]
            prose-h2:font-serif prose-h2:leading-tight
            prose-h3:mt-8 prose-h3:mb-3 prose-h3:text-[22px]
            prose-h3:font-semibold prose-h3:leading-tight
            prose-p:text-[17px] prose-p:text-[#2C2C2C] prose-p:leading-[1.7] prose-p:mb-6
            prose-a:text-[#2D5F4F] prose-a:no-underline prose-a:font-medium
            hover:prose-a:underline
            prose-strong:text-[#2C2C2C] prose-strong:font-semibold
            prose-ul:text-[17px] prose-ul:text-[#2C2C2C] prose-ul:leading-[1.8] prose-ul:my-6
            prose-ol:text-[17px] prose-ol:text-[#2C2C2C] prose-ol:leading-[1.8] prose-ol:my-6
            prose-li:my-3 prose-li:marker:text-[#2D5F4F]
            prose-img:rounded-xl prose-img:shadow-xl prose-img:my-12 prose-img:w-full prose-img:max-w-2xl prose-img:mx-auto prose-img:h-auto
            prose-blockquote:border-l-4 prose-blockquote:border-[#2D5F4F]
            prose-blockquote:bg-[#F8F6F3] prose-blockquote:pl-6 prose-blockquote:py-6
            prose-blockquote:italic prose-blockquote:text-[19px] prose-blockquote:my-8
            prose-blockquote:text-[#2C2C2C]
            ">
            <Content 
              components={{
                ArticleBookingWidget,
                HotelShowcase,
                HotelGrid,
                ActivityShowcase,
                TripCalculator,
                HotelComparison,
                SeasonComparison,
                GroupTypeRecommender,
                EventPlanningTimeline,
                GroupCostCalculator,
                HotelSplitCalculator,
                CostPerPersonRanking,
                BudgetToItineraryPlanner,
              }}
            />
          </div>

          <!-- Tags -->
          {data.tags && data.tags.length > 0 && (
            <div class="mt-12 border-t border-[#E5E5E5] pt-8">
              <h3 class="mb-4 text-sm font-semibold uppercase tracking-wide text-[#666]">
                Tags
              </h3>
              <div class="flex flex-wrap gap-2">
                {data.tags.map(tag => (
                  <a
                    href={`/blog/tag/${tag}`}
                    class="rounded-full bg-[#F8F6F3] px-4 py-2 text-sm text-[#2D5F4F] transition-colors hover:bg-[#2D5F4F] hover:text-white"
                  >
                    {tag}
                  </a>
                ))}
              </div>
            </div>
          )}

          <!-- Share Again -->
          <div class="mt-12 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 border-t border-[#E5E5E5] pt-8">
            <div class="text-sm font-medium text-[#666]">
              Found this helpful? Share it:
            </div>
            <ShareButtons client:load url={fullUrl} title={data.title} />
          </div>

        </div>

        <!-- Sidebar -->
        <aside class="space-y-6">
          <!-- Table of Contents -->
          {headings.length > 0 && (
            <TableOfContents client:load headings={headings} />
          )}

          <!-- Newsletter Signup -->
          <div class="rounded-lg border border-[#E5E8E5] bg-white p-6 shadow-sm">
            <h3 class="mb-3 text-lg font-bold text-[#2C2C2C]">
              Get Travel Tips
            </h3>
            <p class="mb-4 text-sm text-[#666]">
              Subscribe to our newsletter for the latest Telluride travel guides and hotel deals.
            </p>
            <form class="space-y-3">
              <input
                type="email"
                placeholder="Your email"
                class="w-full rounded-lg border border-[#D5D5D5] px-4 py-2 text-sm focus:border-[#2D5F4F] focus:outline-none focus:ring-2 focus:ring-[#2D5F4F]/20"
                required
              />
              <button
                type="submit"
                class="w-full rounded-lg bg-[#2D5F4F] px-4 py-2.5 text-sm font-semibold text-white transition-colors hover:bg-[#255040] h-10"
              >
                Subscribe
              </button>
            </form>
          </div>

          <!-- Popular Articles -->
          <div class="rounded-lg border border-[#E5E8E5] bg-white p-6 shadow-sm">
            <h3 class="mb-4 text-lg font-bold text-[#2C2C2C]">
              Popular Articles
            </h3>
            <ul class="space-y-3">
              <li>
                <a href="/blog" class="text-sm text-[#2D5F4F] hover:text-[#255040] hover:underline transition-colors">
                  Best Hotels in Telluride
                </a>
              </li>
              <li>
                <a href="/blog" class="text-sm text-[#2D5F4F] hover:text-[#255040] hover:underline transition-colors">
                  Telluride Ski Resort Guide
                </a>
              </li>
              <li>
                <a href="/blog" class="text-sm text-[#2D5F4F] hover:text-[#255040] hover:underline transition-colors">
                  Where to Stay in Telluride
                </a>
              </li>
            </ul>
          </div>
        </aside>
      </div>

      <!-- Newsletter CTA Section -->
      <div class="max-w-[600px] mx-auto my-16">
        <div class="bg-[#2D5F4F] rounded-xl p-12 text-center">
          <svg class="w-12 h-12 text-white mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          <h3 
            class="text-2xl md:text-3xl font-bold text-white mb-2"
            style="font-family: 'Playfair Display', serif;"
          >
            Get Telluride travel tips in your inbox
          </h3>
          <p class="text-base text-white/90 mb-6">
            Weekly guides, hotel deals, and insider recommendations
          </p>
          <form class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto">
            <input
              type="email"
              placeholder="Your email"
              class="flex-1 h-12 px-4 rounded-lg border-0 focus:outline-none focus:ring-2 focus:ring-white/50"
              required
            />
            <button
              type="submit"
              class="h-12 px-8 bg-[#C87859] text-white font-semibold rounded-lg hover:bg-[#B8694A] transition-colors whitespace-nowrap"
            >
              Subscribe
            </button>
          </form>
          <p class="text-xs text-white/70 mt-4">
            No spam. Unsubscribe anytime.
          </p>
        </div>
      </div>

      <!-- Related Articles -->
      {relatedArticles.length > 0 && (
        <div class="bg-[#F8F9F8] py-20 -mx-4 px-4">
          <Container>
            <RelatedArticles
              client:load
              articles={relatedArticles}
              currentSlug={article.slug}
              maxArticles={3}
            />
          </Container>
        </div>
      )}
    </Container>
  </article>

  <!-- Schema.org JSON-LD -->
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": data.title,
    "description": data.excerpt,
    "image": data.featuredImage,
    "datePublished": data.publishDate.toISOString(),
    "dateModified": data.updatedDate?.toISOString() || data.publishDate.toISOString(),
    "author": {
      "@type": "Organization",
      "name": data.author
    },
    "publisher": {
      "@type": "Organization",
      "name": "Telluride Ski Hotels",
      "logo": {
        "@type": "ImageObject",
        "url": `${Astro.site}favicon-icon.png`
      }
    },
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": fullUrl
    },
    "keywords": data.seo.keywords.join(", "),
    "wordCount": data.wordCount,
    "articleSection": categoryName
  })} />

  <!-- FAQ Accordion Script -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', () => {
      // Find FAQ section (h2 with text containing "FAQ")
      const allH2s = document.querySelectorAll('.prose h2');
      let faqH2 = null;
      
      allH2s.forEach(h2 => {
        if (h2.textContent.toLowerCase().includes('faq')) {
          faqH2 = h2;
        }
      });
      
      if (!faqH2) return;
      
      // Get all h3 elements after the FAQ h2 until the next h2
      const faqItems = [];
      let currentElement = faqH2.nextElementSibling;
      
      while (currentElement && currentElement.tagName !== 'H2') {
        if (currentElement.tagName === 'H3') {
          const question = currentElement;
          const answer = question.nextElementSibling;
          if (answer && answer.tagName === 'P') {
            faqItems.push({ question, answer });
          }
        }
        currentElement = currentElement.nextElementSibling;
      }
      
      // Create accordion for each FAQ item
      faqItems.forEach(({ question, answer }) => {
        // Create accordion wrapper
        const wrapper = document.createElement('div');
        wrapper.className = 'border border-neutral-200 rounded-xl overflow-hidden bg-white shadow-sm hover:shadow-md transition-shadow duration-200 my-3';
        
        // Create button wrapper for question
        const button = document.createElement('button');
        button.className = 'w-full px-6 py-4 text-left flex items-center justify-between hover:bg-neutral-50 transition-colors duration-150';
        button.setAttribute('aria-expanded', 'false');
        button.type = 'button';
        
        // Create question text
        const questionText = document.createElement('h3');
        questionText.className = 'text-lg font-semibold text-neutral-900 pr-4 m-0';
        questionText.textContent = question.textContent;
        
        // Create chevron icon
        const icon = document.createElement('svg');
        icon.className = 'w-5 h-5 text-neutral-600 flex-shrink-0 transition-transform duration-200';
        icon.setAttribute('fill', 'none');
        icon.setAttribute('stroke', 'currentColor');
        icon.setAttribute('viewBox', '0 0 24 24');
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />';
        
        button.appendChild(questionText);
        button.appendChild(icon);
        
        // Create answer wrapper
        const answerWrapper = document.createElement('div');
        answerWrapper.className = 'max-h-0 overflow-hidden transition-all duration-300';
        answerWrapper.style.maxHeight = '0';
        
        const answerContent = document.createElement('div');
        answerContent.className = 'px-6 pb-4 text-neutral-700 leading-relaxed';
        answerContent.innerHTML = answer.innerHTML;
        
        answerWrapper.appendChild(answerContent);
        
        // Build structure
        wrapper.appendChild(button);
        wrapper.appendChild(answerWrapper);
        
        // Insert before question
        question.parentNode.insertBefore(wrapper, question);
        
        // Remove original elements
        question.remove();
        answer.remove();
        
        // Add click handler
        button.addEventListener('click', () => {
          const isOpen = button.getAttribute('aria-expanded') === 'true';
          
          if (isOpen) {
            button.setAttribute('aria-expanded', 'false');
            answerWrapper.style.maxHeight = '0';
            icon.style.transform = 'rotate(0deg)';
          } else {
            button.setAttribute('aria-expanded', 'true');
            answerWrapper.style.maxHeight = (answerContent.scrollHeight + 32) + 'px';
            icon.style.transform = 'rotate(180deg)';
          }
        });
      });
    });
  </script>
</PageLayout>

