---
import PageLayout from '@/components/layout/PageLayout.astro';
import Container from '@/components/layout/Container.astro';
import { BookingsList } from '@/components/account/BookingsList';
import { getSessionFromRequest } from '@/lib/auth';
import { Building2, Calendar, User, LogOut, Mail, Shield } from 'lucide-react';

export const prerender = false;

const session = await getSessionFromRequest(Astro.request);

if (!session) {
  return Astro.redirect('/account/login?redirect=/account');
}

const isOAuthUser = session.user.oauthProvider;
const providerName = session.user.oauthProvider === 'google' ? 'Google' : session.user.oauthProvider === 'apple' ? 'Apple' : null;
---

<PageLayout
  title="My Account"
  description="Manage your Telluride bookings, loyalty perks, and upcoming stays."
>
  <Container class="py-8 lg:py-12">
    <div class="max-w-7xl mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Sidebar -->
        <div class="lg:col-span-1">
          <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 overflow-hidden sticky top-24">
            <!-- Profile Header -->
            <div class="bg-gradient-to-br from-primary-600 to-primary-700 p-6 text-white">
              {session.user.image ? (
                <img 
                  src={session.user.image} 
                  alt={session.user.name || 'Profile'} 
                  class="w-20 h-20 rounded-full border-4 border-white/20 mb-3"
                />
              ) : (
                <div class="w-20 h-20 rounded-full bg-white/20 border-4 border-white/20 flex items-center justify-center mb-3">
                  <User className="w-10 h-10" />
                </div>
              )}
              <h2 class="text-xl font-bold mb-1">{session.user.name || 'Guest'}</h2>
              <p class="text-sm text-primary-100">{session.user.email}</p>
              {isOAuthUser && (
                <div class="mt-3 inline-flex items-center gap-2 px-3 py-1 bg-white/20 rounded-full text-xs font-semibold">
                  <Shield className="w-3 h-3" />
                  Signed in with {providerName}
                </div>
              )}
            </div>

            <!-- Navigation -->
            <nav class="p-2">
              <a 
                href="/account" 
                class="flex items-center gap-3 px-4 py-3 text-neutral-900 bg-primary-50 rounded-xl font-semibold mb-1"
              >
                <Building2 className="w-5 h-5 text-primary-600" />
                My Bookings
              </a>
              <a 
                href="/places-to-stay" 
                class="flex items-center gap-3 px-4 py-3 text-neutral-600 hover:bg-neutral-50 rounded-xl font-medium mb-1 transition-colors"
              >
                <Calendar className="w-5 h-5" />
                Book New Stay
              </a>
              <a 
                href="/find-booking" 
                class="flex items-center gap-3 px-4 py-3 text-neutral-600 hover:bg-neutral-50 rounded-xl font-medium mb-1 transition-colors"
              >
                <Mail className="w-5 h-5" />
                Find Guest Booking
              </a>
            </nav>

            <div class="border-t border-neutral-200 p-2">
              <form method="post" action="/api/auth/sign-out">
                <button 
                  type="submit"
                class="w-full flex items-center gap-3 px-4 py-3 text-rose-600 hover:bg-rose-50 rounded-xl font-semibold transition-colors"
              >
                <LogOut className="w-5 h-5" />
                  Sign Out
                </button>
              </form>
            </div>
          </div>
        </div>

        <!-- Main Content -->
        <div class="lg:col-span-3">
          <div class="bg-white rounded-2xl shadow-sm border border-neutral-200 p-8">
            <div class="mb-8">
              <h1 class="text-3xl font-bold text-neutral-900 mb-2">My Bookings</h1>
              <p class="text-neutral-600">
                View all your reservations, download confirmations, and manage your stays.
              </p>
            </div>

            <BookingsList client:load />
          </div>

          <!-- Quick Actions -->
          <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <a 
              href="/places-to-stay"
              class="group bg-gradient-to-br from-primary-600 to-primary-700 rounded-2xl p-6 text-white hover:shadow-lg transition-all"
            >
              <Building2 className="w-8 h-8 mb-3 opacity-90" />
              <h3 class="text-lg font-bold mb-1">Book Another Stay</h3>
              <p class="text-sm text-primary-100">Explore hotels and find your perfect room</p>
              <div class="mt-4 flex items-center gap-2 text-sm font-semibold group-hover:gap-3 transition-all">
                Browse Hotels
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </a>

            <a 
              href="/mountain-conditions"
              class="group bg-white border-2 border-neutral-200 rounded-2xl p-6 hover:border-primary-300 hover:shadow-lg transition-all"
            >
              <Calendar className="w-8 h-8 mb-3 text-primary-600" />
              <h3 class="text-lg font-bold text-neutral-900 mb-1">Check Conditions</h3>
              <p class="text-sm text-neutral-600">Live weather, snow reports, and trail status</p>
              <div class="mt-4 flex items-center gap-2 text-sm font-semibold text-primary-600 group-hover:gap-3 transition-all">
                View Conditions
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </a>
          </div>
        </div>

      </div>
    </div>
  </Container>
</PageLayout>

