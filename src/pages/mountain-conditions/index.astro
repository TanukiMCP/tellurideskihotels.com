---
export const prerender = false;

import PageLayout from '@/components/layout/PageLayout.astro';
import Container from '@/components/layout/Container.astro';
import { SkiConditionsWidget } from '@/components/ski/SkiConditionsWidget';
import { OffSeasonCountdown } from '@/components/ski/OffSeasonCountdown';
import { CurrentConditions } from '@/components/weather/CurrentConditions';
import { WebcamLinks } from '@/components/info/WebcamLinks';
import { getTellurideSkiConditions } from '@/lib/snocountry/client';
import { getImagesByCategory } from '@/lib/image-library';
import { optimizePexelsImage, generateSrcSet } from '@/lib/image-optimizer';

const pageTitle = 'Telluride Mountain Conditions | Live Ski Report & Weather';
const pageDescription = 'Real-time ski conditions, snow reports, weather forecast, and live webcams for Telluride Ski Resort. Plan your perfect ski day with up-to-date mountain information.';

// Get hero background image
const mountainImages = getImagesByCategory('mountains') || getImagesByCategory('resort');
const heroImage = mountainImages[0];
const optimizedHeroUrl = heroImage ? optimizePexelsImage(heroImage.url, { width: 1920, quality: 85 }) : null;
const heroSrcSet = heroImage ? generateSrcSet(heroImage.url, [640, 768, 1024, 1280, 1536, 1920]) : null;

// Check if it's currently ski season (roughly late November to early April)
const currentDate = new Date();
const currentMonth = currentDate.getMonth(); // 0-11
const isSkiSeason = currentMonth >= 10 || currentMonth <= 3; // November (10) through April (3)

// Determine next season start date
let nextSeasonStart: Date;
if (currentMonth >= 4 && currentMonth <= 10) {
  // Summer/Fall - next season starts in November of current year
  nextSeasonStart = new Date(currentDate.getFullYear(), 10, 22); // Nov 22
} else {
  // Winter/Spring - next season starts in November of next year
  nextSeasonStart = new Date(currentDate.getFullYear() + 1, 10, 22); // Nov 22 next year
}

// Fetch ski conditions server-side (only if in season)
let skiConditions = null;

if (isSkiSeason) {
  try {
    skiConditions = await getTellurideSkiConditions();
    console.log('[Mountain Conditions] Loaded ski conditions');
  } catch (error) {
    console.error('[Mountain Conditions] Error fetching ski conditions:', error);
  }
}
---

<PageLayout title={pageTitle} description={pageDescription}>
  <!-- Hero Section -->
  <div class="relative bg-gradient-to-br from-sky-600 via-sky-700 to-sky-800 text-white py-20 lg:py-28 overflow-hidden">
    {heroImage ? (
      <>
        <img 
          src={optimizePexelsImage(heroImage.url, { width: 1920, quality: 85 })}
          srcset={generateSrcSet(heroImage.url, [640, 768, 1024, 1280, 1536, 1920])}
          sizes="100vw"
          alt="Telluride Mountain Conditions" 
          class="absolute inset-0 w-full h-full object-cover"
        />
        <div class="absolute inset-0 bg-gradient-to-br from-sky-900/85 via-sky-800/80 to-sky-900/85"></div>
      </>
    ) : (
      <div class="absolute inset-0 opacity-10">
        <div class="absolute inset-0" style="background-image: url('data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffffff\' fill-opacity=\'1\'%3E%3Cpath d=\'M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E');"></div>
      </div>
    )}
    <Container class="relative z-10">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-display-md lg:text-display-lg mb-6 font-extrabold drop-shadow-lg">
          Mountain Conditions
        </h1>
        <p class="text-xl lg:text-2xl mb-8 text-white/90 font-medium leading-relaxed max-w-3xl mx-auto">
          Live ski conditions, snow reports, weather forecasts, and webcams for Telluride Ski Resort. 
          Everything you need to plan your perfect day on the mountain.
        </p>
        <div class="flex flex-wrap justify-center gap-6 text-lg">
          <div class="flex items-center gap-2">
            <svg class="w-6 h-6 text-sky-300" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" />
            </svg>
            <span class="font-semibold">Updated Hourly</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-6 h-6 text-sky-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
            </svg>
            <span class="font-semibold">10-Day Forecast</span>
          </div>
        </div>
      </div>
    </Container>
  </div>

  <!-- Quick Stats Strip -->
  {skiConditions && skiConditions.lifts.open > 0 && (
    <div class="bg-white border-b border-neutral-200 py-6">
      <Container>
        <div class="flex flex-wrap justify-center items-center gap-8 lg:gap-16 text-center">
          <div class="flex flex-col">
            <div class="text-3xl font-bold text-sky-600">{skiConditions.conditions.newSnow24hr}"</div>
            <div class="text-sm text-neutral-600 font-medium">24hr Snowfall</div>
          </div>
          <div class="flex flex-col">
            <div class="text-3xl font-bold text-primary-600">{skiConditions.trails.open}/{skiConditions.trails.total}</div>
            <div class="text-sm text-neutral-600 font-medium">Trails Open</div>
          </div>
          <div class="flex flex-col">
            <div class="text-3xl font-bold text-accent-600">{skiConditions.lifts.open}/{skiConditions.lifts.total}</div>
            <div class="text-sm text-neutral-600 font-medium">Lifts Operating</div>
          </div>
          <div class="flex flex-col">
            <div class="text-3xl font-bold text-secondary-600">{skiConditions.conditions.baseDepthMax}"</div>
            <div class="text-sm text-neutral-600 font-medium">Summit Base</div>
          </div>
        </div>
      </Container>
    </div>
  )}

  <!-- Main Content -->
  <div class="py-16 lg:py-20">
    <Container>
      {isSkiSeason ? (
        <>
          <!-- Ski Conditions -->
          <section class="mb-16">
            <div class="text-center mb-10">
              <h2 class="text-display-sm lg:text-display-md mb-4 text-neutral-900 font-bold">Current Ski Conditions</h2>
              <p class="text-lg text-neutral-600 max-w-2xl mx-auto">
                Live snow report updated throughout the day
              </p>
            </div>
            <SkiConditionsWidget client:load initialConditions={skiConditions} />
          </section>

          <!-- Weather Forecast & Webcams -->
          <section class="mb-16">
            <div class="text-center mb-10">
              <h2 class="text-display-sm lg:text-display-md mb-4 text-neutral-900 font-bold">Weather & Live Views</h2>
              <p class="text-lg text-neutral-600 max-w-2xl mx-auto">
                Detailed forecast and live webcam access to plan your perfect ski day
              </p>
            </div>
            
            <div class="grid lg:grid-cols-3 gap-8">
              <!-- Weather Forecast (takes 2 columns) -->
              <div class="lg:col-span-2">
                <CurrentConditions client:load />
              </div>

              <!-- Webcam Links (takes 1 column) -->
              <div class="lg:col-span-1">
                <WebcamLinks client:load />
              </div>
            </div>
          </section>
        </>
      ) : (
        <!-- Off-Season Countdown -->
        <section class="mb-16">
          <OffSeasonCountdown client:load seasonStartDate={nextSeasonStart} />
        </section>
      )}

      <!-- Trail Map Info -->
      <section class="bg-gradient-to-br from-primary-50 to-white rounded-3xl p-12 border border-primary-200 shadow-card">
        <div class="max-w-4xl mx-auto text-center">
          <h2 class="text-display-sm mb-6 font-bold text-neutral-900">Trail Map & Mountain Stats</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
            <div>
              <div class="text-4xl font-bold text-primary-600 mb-2">148</div>
              <div class="text-sm text-neutral-600 font-medium">Total Trails</div>
            </div>
            <div>
              <div class="text-4xl font-bold text-accent-600 mb-2">2,000+</div>
              <div class="text-sm text-neutral-600 font-medium">Skiable Acres</div>
            </div>
            <div>
              <div class="text-4xl font-bold text-secondary-600 mb-2">4,425'</div>
              <div class="text-sm text-neutral-600 font-medium">Vertical Drop</div>
            </div>
          </div>
          <p class="text-neutral-700 mb-6 leading-relaxed">
            Telluride Ski Resort features 148 trails across 2,000+ acres of skiable terrain, 
            with a vertical drop of 4,425 feet. From beginner greens to expert double blacks, 
            there's something for every skill level.
          </p>
          <a
            href="https://www.tellurideskiresort.com/the-mountain/trail-map.aspx"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center gap-2 bg-primary-600 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-card hover:shadow-card-hover hover:bg-primary-700 transition-all duration-300"
          >
            View Interactive Trail Map
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
            </svg>
          </a>
        </div>
      </section>
    </Container>
  </div>

  <!-- CTA Section with Background Image -->
  <div class="relative py-32 lg:py-40 overflow-hidden">
    {mountainImages && mountainImages[1] ? (
      <>
        <img 
          src={optimizePexelsImage(mountainImages[1].url, { width: 1920, quality: 85 })}
          srcset={generateSrcSet(mountainImages[1].url, [640, 768, 1024, 1280, 1536, 1920])}
          sizes="100vw"
          alt="Telluride Ski Slopes" 
          class="absolute inset-0 w-full h-full object-cover"
          loading="lazy"
        />
        <div class="absolute inset-0 bg-gradient-to-r from-sky-900/90 via-sky-800/85 to-sky-900/90"></div>
      </>
    ) : (
      <div class="absolute inset-0 bg-gradient-to-br from-sky-600 via-sky-700 to-sky-800"></div>
    )}
    
    <Container class="relative">
      <div class="max-w-4xl mx-auto text-center text-white">
        <h2 class="text-4xl md:text-5xl lg:text-6xl mb-6 font-extrabold drop-shadow-2xl leading-tight">
          Ready to Hit the Slopes?
        </h2>
        <p class="text-xl lg:text-2xl mb-12 leading-relaxed font-medium text-white/95 max-w-3xl mx-auto drop-shadow-lg">
          With perfect conditions and endless terrain, there's never been a better time to experience world-class skiing in Telluride.
        </p>
        <div class="flex flex-wrap justify-center gap-6">
          <a
            href="/places-to-stay"
            class="inline-flex items-center gap-3 bg-white text-sky-600 px-10 py-5 rounded-xl font-bold text-lg shadow-2xl hover:shadow-2xl hover:scale-105 transition-all duration-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            Book Your Stay
          </a>
          <a
            href="/things-to-do"
            class="inline-flex items-center gap-3 bg-sky-900/50 backdrop-blur-sm text-white px-10 py-5 rounded-xl font-bold text-lg border-2 border-white/30 hover:bg-sky-900/70 hover:border-white/50 transition-all duration-300"
          >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            Explore Activities
          </a>
        </div>
      </div>
    </Container>
  </div>
</PageLayout>

