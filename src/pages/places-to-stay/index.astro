---
export const prerender = false;

import PageLayout from '@/components/layout/PageLayout.astro';
import Container from '@/components/layout/Container.astro';
import { HotelGridWithMap } from '@/components/lodging/HotelGridWithMap';
import { HotelSearchWidget } from '@/components/lodging/HotelSearchWidget';
import { WeatherWidget } from '@/components/weather/WeatherWidget';
import Breadcrumbs from '@/components/seo/Breadcrumbs.astro';
import type { LiteAPIHotel } from '@/lib/liteapi/types';
import { DEFAULT_LOCATION, DEFAULT_COUNTRY_CODE } from '@/lib/constants';

const url = Astro.url;
const searchParams = url.searchParams;
const location = searchParams.get('location') || DEFAULT_LOCATION;
let checkIn = searchParams.get('checkIn') || '';
let checkOut = searchParams.get('checkOut') || '';
const adults = parseInt(searchParams.get('adults') || '2', 10);

// Auto-fill default dates if not provided (7 days from now, 7 night stay)
if (!checkIn || !checkOut) {
  const today = new Date();
  const defaultCheckIn = new Date(today);
  defaultCheckIn.setDate(today.getDate() + 7);
  const defaultCheckOut = new Date(defaultCheckIn);
  defaultCheckOut.setDate(defaultCheckIn.getDate() + 7);
  
  checkIn = checkIn || defaultCheckIn.toISOString().split('T')[0];
  checkOut = checkOut || defaultCheckOut.toISOString().split('T')[0];
  
  // Redirect to include dates in URL so prices show
  const newUrl = new URL(url);
  newUrl.searchParams.set('checkIn', checkIn);
  newUrl.searchParams.set('checkOut', checkOut);
  return Astro.redirect(newUrl.toString(), 302);
}

let hotels: LiteAPIHotel[] = [];
let minPrices: Record<string, number> = {};
let loading = false;
let hasSearched = false;

// Always fetch hotels with availability when dates are provided
if (checkIn && checkOut) {
  hasSearched = true;
  try {
    loading = true;
    
    console.log('[Places to Stay Page] Searching for hotels WITH availability:', {
      location,
      checkIn,
      checkOut,
      adults,
    });
    
    const { searchHotelsWithRates } = await import('@/lib/liteapi/rates');
    const result = await searchHotelsWithRates({
      cityName: location,
      countryCode: DEFAULT_COUNTRY_CODE,
      checkIn,
      checkOut,
      adults,
      // No limit - get all available hotels
    });
    
    hotels = result.hotels || [];
    minPrices = result.minPrices || {};
    
    console.log('[Places to Stay Page] Search complete:', {
      hotelsFound: hotels.length,
      hotelsWithPrices: Object.keys(minPrices).length,
      sampleHotel: hotels[0]?.name,
      samplePrice: Object.values(minPrices)[0],
    });
    
  } catch (error) {
    console.error('[Places to Stay Page] Error searching hotels:', {
      error: error instanceof Error ? error.message : 'Unknown error',
      stack: error instanceof Error ? error.stack : undefined,
    });
    hotels = [];
  } finally {
    loading = false;
    console.log('[Places to Stay Page] Load complete');
  }
}

const nights = checkIn && checkOut 
  ? Math.ceil((new Date(checkOut).getTime() - new Date(checkIn).getTime()) / (1000 * 60 * 60 * 24))
  : 1;
---

<PageLayout
  title={`Places to Stay in ${location} - Search & Compare Prices`}
  description={`Search and book places to stay in ${location}. Compare prices, read reviews, and book directly with instant confirmation.`}
>
  <Container class="py-12 lg:py-16">
    <Breadcrumbs items={[
      { label: 'Home', href: '/' },
      { label: 'Places to Stay', href: '/places-to-stay' },
    ]} />

    <div class="mb-12">
      <h1 class="text-display-sm lg:text-display-md text-neutral-900 mb-3">Find Your Perfect Place to Stay</h1>
      <p class="text-xl text-neutral-600 mb-8 max-w-3xl">
        Compare prices and availability across all accommodations in {location}. From luxury hotels to cozy mountain lodges, find the perfect base for your Telluride adventure with instant booking confirmation.
      </p>
      
      <HotelSearchWidget
        client:idle
        initialLocation={location}
        initialDates={checkIn && checkOut ? {
          checkIn: new Date(checkIn),
          checkOut: new Date(checkOut),
        } : undefined}
        initialGuests={{ adults, children: 0 }}
      />
    </div>

    {checkIn && checkOut && (
      <div class="mb-10">
        <WeatherWidget client:visible startDate={checkIn} endDate={checkOut} title="Weather for Your Stay" compact={true} />
      </div>
    )}

    <div class="mb-8">
      <div class="flex items-end justify-between mb-4">
        <div>
          <h2 class="text-2xl font-bold text-neutral-900 mb-1">
            {hotels.length > 0 ? `${hotels.length} Available Properties` : 'Loading accommodations...'}
          </h2>
          {checkIn && checkOut && (
            <p class="text-neutral-600">
              {new Date(checkIn).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - {new Date(checkOut).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} • {nights} night{nights !== 1 ? 's' : ''} • {adults} guest{adults !== 1 ? 's' : ''}
            </p>
          )}
        </div>
        {hotels.length > 0 && (
          <p class="text-sm text-neutral-500">
            Showing real-time availability and rates
          </p>
        )}
      </div>
      {hotels.length > 0 && (
        <div class="bg-primary-50 border border-primary-200 rounded-lg p-4">
          <p class="text-sm text-neutral-700 leading-relaxed">
            <strong class="text-neutral-900">All prices shown include taxes and fees.</strong> We partner with local resorts to provide you the best prices, comparable to that of industry leaders. Book with confidence – instant confirmation and free cancellation on most properties. Need help? Our team is available 24/7 to assist with your reservation.
          </p>
        </div>
      )}
    </div>

    <!-- Split-screen Layout with Map Sync -->
    <HotelGridWithMap
      client:idle
      hotels={hotels}
      loading={loading}
      minPrices={minPrices}
      currency="USD"
      nights={nights}
      checkIn={checkIn}
      checkOut={checkOut}
      adults={adults}
    />
  </Container>
</PageLayout>

