---
export const prerender = false;

import PageLayout from '@/components/layout/PageLayout.astro';
import Container from '@/components/layout/Container.astro';
import { HotelGridWithMap } from '@/components/lodging/HotelGridWithMap';
import { HotelSearchWidget } from '@/components/lodging/HotelSearchWidget';
import Breadcrumbs from '@/components/seo/Breadcrumbs.astro';
import type { LiteAPIHotel } from '@/lib/liteapi/types';
import { DEFAULT_LOCATION, DEFAULT_COUNTRY_CODE } from '@/lib/constants';

const url = Astro.url;
const searchParams = url.searchParams;
const location = searchParams.get('location') || DEFAULT_LOCATION;
const checkIn = searchParams.get('checkIn') || '';
const checkOut = searchParams.get('checkOut') || '';
const adults = parseInt(searchParams.get('adults') || '2', 10);

let hotels: LiteAPIHotel[] = [];
let minPrices: Record<string, number> = {};
let loading = false;

// If no dates provided, use defaults (30-37 days out for better availability)
let effectiveCheckIn = checkIn;
let effectiveCheckOut = checkOut;
let usingDefaultDates = false;

// Always show hotels, defaulting to Telluride
try {
  loading = true;
  
  if (!checkIn || !checkOut) {
    const { format, addDays } = await import('date-fns');
    effectiveCheckIn = format(addDays(new Date(), 30), 'yyyy-MM-dd');
    effectiveCheckOut = format(addDays(new Date(), 37), 'yyyy-MM-dd');
    usingDefaultDates = true;
    console.log('[Lodging Page] No dates provided, using defaults:', { effectiveCheckIn, effectiveCheckOut });
  }
  
  console.log('[Lodging Page] Loading hotels:', {
    location,
    checkIn: effectiveCheckIn,
    checkOut: effectiveCheckOut,
    adults,
    usingDefaultDates,
  });
  
  const { searchHotels } = await import('@/lib/liteapi/hotels');
  const hotelData = await searchHotels({
    cityName: location,
    countryCode: DEFAULT_COUNTRY_CODE,
    limit: 100, // Get all Telluride hotels for full search experience
  });
  
  hotels = hotelData.data || [];
  console.log('[Lodging Page] Hotels loaded:', hotels.length);
    
            if (effectiveCheckIn && effectiveCheckOut && hotels.length > 0) {
      try {
        console.log('[Lodging Page] Fetching rates for', hotels.length, 'hotels');
        
        // Get hotel IDs
        const hotelIds = hotels.map(h => h.hotel_id).filter(Boolean);
        
        if (hotelIds.length === 0) {
          console.warn('[Lodging Page] No valid hotel IDs found');
        } else {
          const { searchRates } = await import('@/lib/liteapi/rates');
          const ratesData = await searchRates({
            hotelIds: hotelIds.join(','),
            checkIn: effectiveCheckIn,
            checkOut: effectiveCheckOut,
            adults,
          });
        
          if (ratesData.data && ratesData.data.length > 0) {
            console.log('[Lodging Page] Processing rates for', ratesData.data.length, 'hotels');
            ratesData.data.forEach((hotel: any) => {
              // Get minimum price from all rooms (already per-night from rates.ts)
              const hotelMinPrice = hotel.rooms?.flatMap((r: any) =>
                r.rates?.map((rate: any) => rate.net?.amount || Infinity)
              ).filter((p: number) => p !== Infinity);

              if (hotelMinPrice && hotelMinPrice.length > 0) {
                minPrices[hotel.hotel_id] = Math.min(...hotelMinPrice);
              }
            });
            
            // Only filter hotels if user explicitly selected dates
            if (!usingDefaultDates) {
              const hotelsWithRates = new Set(Object.keys(minPrices));
              hotels = hotels.filter(h => hotelsWithRates.has(h.hotel_id));
              console.log('[Lodging Page] User selected dates - filtered to hotels with availability');
            }
            
            console.log('[Lodging Page] Hotels with prices:', {
              hotelsWithPrices: Object.keys(minPrices).length,
              totalHotels: hotels.length,
              samplePrice: Object.values(minPrices)[0],
              usingDefaultDates,
            });
          } else {
            console.warn('[Lodging Page] No rate data returned');
            // If user explicitly selected dates but no rates, show no hotels
            if (!usingDefaultDates) {
              hotels = [];
            }
          }
        }
      } catch (rateError) {
        console.error('[Lodging Page] Error fetching rates:', {
          error: rateError instanceof Error ? rateError.message : 'Unknown error',
          stack: rateError instanceof Error ? rateError.stack : undefined,
        });
      }
    }
} catch (error) {
  console.error('[Lodging Page] Error fetching hotels:', {
    error: error instanceof Error ? error.message : 'Unknown error',
    stack: error instanceof Error ? error.stack : undefined,
  });
  hotels = [];
} finally {
  loading = false;
  console.log('[Lodging Page] Load complete');
}

const nights = effectiveCheckIn && effectiveCheckOut 
  ? Math.ceil((new Date(effectiveCheckOut).getTime() - new Date(effectiveCheckIn).getTime()) / (1000 * 60 * 60 * 24))
  : 1;
---

<PageLayout
  title={`Ski Hotels in ${location} - Search & Compare Prices`}
  description={`Search and book ski hotels in ${location}. Compare prices, read reviews, and book directly with instant confirmation.`}
>
  <Container class="py-12 lg:py-16">
    <Breadcrumbs items={[
      { label: 'Home', href: '/' },
      { label: 'Hotels', href: '/lodging' },
    ]} />

    <div class="mb-12">
      <h1 class="text-display-sm lg:text-display-md text-neutral-900 mb-2">Find Your Perfect Hotel</h1>
      <p class="text-xl text-neutral-600 mb-8">Search and compare hotels in {location}</p>
      
      <HotelSearchWidget
        client:load
        initialLocation={location}
        initialDates={checkIn && checkOut ? {
          checkIn: new Date(checkIn),
          checkOut: new Date(checkOut),
        } : undefined}
        initialGuests={{ adults, children: 0 }}
      />
    </div>

    <div class="mb-6">
      <h2 class="text-2xl font-bold text-neutral-900 mb-2">
        {hotels.length > 0 ? `${hotels.length} Hotels in ${location}` : 'Loading Hotels...'}
      </h2>
      {checkIn && checkOut && (
        <p class="text-neutral-600">
          {new Date(checkIn).toLocaleDateString()} - {new Date(checkOut).toLocaleDateString()} • {nights} night{nights !== 1 ? 's' : ''} • {adults} adult{adults !== 1 ? 's' : ''}
        </p>
      )}
    </div>

    <!-- Split-screen Layout with Map Sync -->
    <HotelGridWithMap
      client:load
      hotels={hotels}
      loading={loading}
      minPrices={minPrices}
      currency="USD"
      nights={nights}
      checkIn={effectiveCheckIn}
      checkOut={effectiveCheckOut}
      adults={adults}
    />
  </Container>
</PageLayout>
